name: Release Note on PR Merge

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      run_name:
        description: "Enter a run name for this run"
        required: true

run-name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_name || github.event.pull_request.title }}

jobs:
  release-note:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      JIRA_API_EMAIL: ${{ secrets.JIRA_API_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_BASE_URL: https://buyandship.atlassian.net

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Format release note
        id: format_note
        run: |
          HASH=${{ github.event.pull_request.merge_commit_sha || github.sha }}
          DATE=$(date "+%Y/%m/%d %H:%M")
          TITLE="${{ github.event.pull_request.title || github.event.inputs.run_name || 'Manual run' }}"

          # æŠ“å‡ºæ‰€æœ‰ BC-XXXX
          TICKETS=$(echo "$TITLE" | grep -oE 'BC-[0-9]+')

          JIRA_LINKS=""

          if [ -z "$TICKETS" ]; then
            JIRA_LINKS="No ticket found"
          else
            for TICKET in $TICKETS; do
              SUMMARY=$(curl -s -u "$JIRA_API_EMAIL:$JIRA_API_TOKEN" \
                -H "Accept: application/json" \
                "$JIRA_BASE_URL/rest/api/2/issue/$TICKET" | jq -r '.fields.summary')

              LINK="[$TICKET] $SUMMARY ($JIRA_BASE_URL/browse/$TICKET)"
              JIRA_LINKS+="$LINK\n"
            done
          fi

          NOTE="ðŸš€ *Release Deployed*\n"
          NOTE+="â€¢ Repo: \`${{ github.repository }}\`\n"
          NOTE+="â€¢ Hash: \`${HASH:0:7}\`\n"
          NOTE+="â€¢ Date: \`${DATE}\`\n"
          NOTE+="â€¢ Ticket(s):\n$JIRA_LINKS"
          NOTE+="â€¢ View Commit: https://github.com/${{ github.repository }}/commit/${HASH}"

          echo "note=$NOTE" >> $GITHUB_OUTPUT

      - name: Send to Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ steps.format_note.outputs.note }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
